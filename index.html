<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>Spellassic Park ‚Ä¢ Professor Peter's Lab</title>
  <style>
    :root{
      --bg:#0c1222;
      --panel:#1b2236;
      --accent:#ffd460;
      --accent2:#58e28a;
      --danger:#ff6b6b;
      --text:#e9eef6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(100% 140% at 50% -10%, #173057 0%, var(--bg) 60%);
      color:var(--text);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:16px;
    }
    .app{
      width:100%;
      max-width:1280px; /* wide for side-scroller feel */
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    h1{
      font-size: clamp(20px, 3.2vw, 36px);
      letter-spacing:1px;
      margin:0;
      text-shadow: 0 2px 0 #0008;
    }
    .subtitle{opacity:.85; font-size:14px; margin-top:2px}
    .card{
      background: linear-gradient(#232b43,#161d31);
      border:2px solid #2d3760;
      border-radius:16px;
      box-shadow: 0 12px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
      overflow:hidden;
    }
    .card .inner{ padding:14px }
    /* Game canvas */
    #gameWrap{ padding:10px; position:relative; }
    #gameCanvas{
      width:100%;
      aspect-ratio: 16 / 9;
      background:#5eb9ff;
      border-radius:12px;
      border:3px solid #0d1b2a;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      box-shadow: inset 0 0 0 3px #263b54, 0 10px 24px rgba(0,0,0,.35);
      display:block;
      /* Keep canvas from eating too much vertical space on desktop */
      max-height: 54vh;
    }
    @media (max-width: 800px){
      #gameCanvas{ max-height: none; }
    }
    .hud{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-top:10px;
    }
    .lives{font-size:22px; letter-spacing:2px}
    .pill{
      background:#0e1627; border:1px solid #22325a; border-radius:999px; padding:8px 12px; font-weight:600;
    }
    .controls{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    }
    input[type="text"], textarea{
      width:100%;
      background:#0e1627;
      border:2px solid #22325a;
      color:var(--text);
      border-radius:12px;
      padding:12px 12px;
      font-size:18px; /* avoid iOS zoom */
      outline:none;
    }
    textarea{ min-height:140px; resize:vertical }
    button{
      appearance:none; border:none;
      background:linear-gradient(#ffe08a,#ffc34d);
      color:#2a1b00; font-weight:800;
      padding:10px 14px; border-radius:12px;
      border:2px solid #9b6c18; box-shadow: 0 4px 0 #7a540f, 0 8px 18px rgba(0,0,0,.35);
      cursor:pointer; font-size:16px;
    }
    button:active{ transform: translateY(1px); box-shadow: 0 3px 0 #7a540f, 0 4px 10px rgba(0,0,0,.35); }
    .btn-secondary{
      background:linear-gradient(#8fe6b1,#5bd989);
      border-color:#2f7b52; box-shadow: 0 4px 0 #2b6d49, 0 8px 18px rgba(0,0,0,.35);
      color:#062611;
    }
    .btn-ghost{
      background:#0e1627; color:#cde8f8; border-color:#24345a;
    }
    .row{ display:flex; gap:8px; flex-wrap:wrap }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas, "Liberation Mono","Courier New", monospace }
    /* Sketch pad */
    #sketchPad{
      width:100%;
      aspect-ratio: 16/9; /* ~25% less height than previous 4/3 */
      background:#0b1222; border:3px solid #24345a; border-radius:12px;
      image-rendering: pixelated; touch-action: none; display:block;
      box-shadow: inset 0 0 0 3px #1c2743, 0 6px 16px rgba(0,0,0,.35);
    }
    .sketchBar{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap; margin-top:8px;
    }
    .legend{opacity:.85; font-size:13px}
    .badge{
      display:inline-block; padding:4px 8px; border-radius:999px; background:#152038; border:1px solid #273b64; font-size:12px; opacity:.85;
    }
    .tiny{ font-size:12px; opacity:.75 }
    .footerNote{ font-size:12px; opacity:.75; text-align:center; margin-top:8px }
    .overlay{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;
    }
    .overlay .panel{
      pointer-events:auto; text-align:center; padding:16px 22px; background:rgba(0,0,0,.55); border:2px solid #26466f; border-radius:16px;
    }
    .banner{
      position:absolute; left:50%; transform:translateX(-50%);
      top:14px; background:#0e1627; border:2px solid #2f4f7e; padding:8px 14px; border-radius:10px; font-weight:900; letter-spacing:1px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>ü¶ñ Spellassic Park <span class="tiny mono">v1.6</span></h1>
      <div class="subtitle">An 8-bit spelling chase‚Äîescape by Jeep or on foot!</div>
    </header>

    <!-- Single-page layout: word list above, then game -->
    <section class="card" id="mainCard">
      <div class="inner">
        <!-- Word list (top) -->
        <label for="wordList" class="legend">Paste your spelling words (comma or new line):</label>
        <textarea id="wordList" class="mono" placeholder="dinosaur
fossil
jeep
jungle
escape
tunnel
volcano"></textarea>
        <div class="row" style="margin-top:8px">
          <button id="startBtn">Start Game</button>
          <button id="resetBtn" class="btn-ghost">Reset</button>
        </div>
        <div class="tiny" style="opacity:.8; margin-top:6px">On iPhone/iPad, unmute the device for audio.</div>

        <!-- Game area (wide) -->
        <div id="gameWrap" style="margin-top:14px">
          <div id="topBanner" class="banner hide"></div>
          <canvas id="gameCanvas" width="320" height="180"></canvas>

          <div class="hud">
            <div class="pill"><span id="progress">Word 1/1</span></div>
            <div class="lives" id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            <div class="row">
              <button id="muteBtn" class="btn-ghost">üéµ Mute Music</button>
            </div>
          </div>

          <div class="legend" id="prompt" style="margin-top:8px">Listen for the word, then type it below.</div>
          <div class="row controls" style="margin-top:6px">
            <input type="text" id="answer" placeholder="Type the word‚Ä¶" autocomplete="off" autocapitalize="none" spellcheck="false" />
            <button id="goBtn">Go</button>
            <button id="replayBtn" class="btn-ghost" title="Hear the word again">üîä Repeat Word</button>
          </div>

          <div style="margin-top:10px">
            <div class="legend">Practice Here:</div>
            <canvas id="sketchPad" width="400" height="300"></canvas>
            <div class="sketchBar">
              <button id="clearSketch" class="btn-ghost">Clear</button>
              <button class="btn-ghost" id="thinPen">Thin</button>
              <button class="btn-ghost" id="thickPen">Thick</button>
              <span class="badge">Mouse or touch</span>
            </div>
          </div>

          <div class="footerNote">Made for ProfessorPetersLab.com ‚Ä¢ Works on desktop, iPad, and iPhone.</div>
        </div>
      </div>
    </section>
  </div>

  <script>
  // --- 8-bit side scroller with car-to-foot chase transitions ---
  (()=>{
    // DOM
    const startBtn  = document.getElementById('startBtn');
    const goBtn     = document.getElementById('goBtn');
    const replayBtn = document.getElementById('replayBtn');
    const resetBtn  = document.getElementById('resetBtn');
    const answer    = document.getElementById('answer');
    const wordList  = document.getElementById('wordList');
    const livesEl   = document.getElementById('lives');
    const progressEl= document.getElementById('progress');
    const promptEl  = document.getElementById('prompt');
    const muteBtn   = document.getElementById('muteBtn');
    const topBanner = document.getElementById('topBanner');

    const gameCanvas= document.getElementById('gameCanvas');
    const g = gameCanvas.getContext('2d');
    const W = gameCanvas.width;
    const H = gameCanvas.height;

    // Sketch pad
    const sketch = document.getElementById('sketchPad');
    const sg = sketch.getContext('2d');
    const clearSketch = document.getElementById('clearSketch');
    const thinPen = document.getElementById('thinPen');
    const thickPen = document.getElementById('thickPen');

    // State
    let words = [];
    let idx = 0;
    let lives = 3;
    let playing = false;
    let ended = false;
    let currentWord = '';
    let gap = 56; // distance parameter
    let bgScroll = 0;
    let t = 0;
    let audioCtx = null;
    let lastRoarAt = 0;
    let musicMuted = false; // only affects background music

    // Music
    const bgmAudio = new Audio("chip-mode-danijel-zambo-main-version-1431-02-05.mp3");
    bgmAudio.loop = true; bgmAudio.preload='auto'; bgmAudio.volume = 0.35;

    // Modes: 'car' -> 'runner' after 1st life lost
    let mode = 'car';
    let anim = { eatCar:false, catchRunner:false, escape:false };
    let escapeX = null;

    // Entities
    const jeep = { x: 170 + gap/2, y: 104, visible:true };
    const driver = { x: 190, y: 122, vx:1.8, vy:0, visible:false, jumping:false, frame:0 };
    const rex  = { x: 150 - gap/2, y: 86, frame: 0, scale:1.3, mouth:0 };

    // Utility
    function showBanner(text, color){
      topBanner.textContent = text;
      topBanner.style.background = color || '#0e1627';
      topBanner.classList.remove('hide');
      setTimeout(()=> topBanner.classList.add('hide'), 2200);
    }

    // Handle device pixel ratio for sketch pad crispness
    function resizeSketch(){
      const dpr = window.devicePixelRatio || 1;
      const cssW = sketch.clientWidth;
      const cssH = sketch.clientHeight;
      sketch.width  = Math.round(cssW * dpr);
      sketch.height = Math.round(cssH * dpr);
      sg.setTransform(dpr,0,0,dpr,0,0);
      sg.lineCap = 'round';
      sg.lineJoin = 'round';
      sg.lineWidth = penWidth;
      sg.strokeStyle = '#e9eef6';
      sg.fillStyle = '#0b1222';
      sg.fillRect(0,0,sketch.width,sketch.height);
    }
    let penWidth = 4;

    // --- Audio helpers (WebAudio beeps) ---
    function ensureAudio(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    function toneSequence(steps){
      ensureAudio();
      const now = audioCtx.currentTime;
      let t = now;
      steps.forEach(s=>{
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = s.type || 'square';
        o.frequency.value = s.f;
        g.gain.value = 0.0001;
        o.connect(g).connect(audioCtx.destination);
        o.start(t);
        g.gain.setValueAtTime(0.001, t);
        g.gain.exponentialRampToValueAtTime(s.v || 0.3, t + (s.len||0.12)*0.2);
        g.gain.exponentialRampToValueAtTime(0.0001, t + (s.len||0.12));
        o.stop(t + (s.len||0.12));
        t += s.wait || (s.len||0.12)*0.9;
      });
    }
    function sfxCorrect(){ toneSequence([{f: 660, len:.08, type:'square'},{f: 990, len:.08, type:'square'},{f:1320, len:.10, type:'square'}]); }
    function sfxWrong(){ toneSequence([{f:220, len:.16, type:'sawtooth', v:.25},{f:160, len:.18, type:'sawtooth', v:.22}]); }
    function sfxRoar(){ toneSequence([{f:220,len:.20,type:'triangle',v:.35},{f:150,len:.25,type:'triangle',v:.32},{f:110,len:.30,type:'triangle',v:.28}]); lastRoarAt=performance.now(); }
    function sfxEscape(){ toneSequence([{f:523,len:.12},{f:659,len:.12},{f:784,len:.24},{f:1046,len:.2,wait:.12}]); }

    // --- Speech (Web Speech API) ---
    function speak(text){
      try{
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 0.95;
        const voices = window.speechSynthesis.getVoices();
        const v = voices.find(v=>/Samantha|Moira|Karen|Daniel|Victoria|Allison|Ava|Alyss/i.test(v.name));
        if(v) u.voice = v;
        window.speechSynthesis.speak(u);
      }catch(e){ /* ignore */ }
    }

    // --- Music control (only background music) ---
    function toggleMusic(){
      musicMuted = !musicMuted;
      muteBtn.textContent = musicMuted ? 'üéµ Unmute Music' : 'üéµ Mute Music';
      try{ bgmAudio.muted = musicMuted; }catch(e){}
    }

    // --- Game flow ---
    function setLives(n){
      lives = Math.max(0, Math.min(3, n));
      livesEl.textContent = '‚ù§Ô∏è'.repeat(lives) + 'ü¶ñ'.repeat(3-lives);
    }
    function setProgress(i,total){
      progressEl.textContent = `Word ${Math.min(i+1,total)}/${total}`;
    }
    function parseWords(text){
      return text.split(/[\n,]+/).map(w=>w.trim()).filter(Boolean);
    }
    function startGame(){
      words = parseWords(wordList.value);
      if(words.length===0){
        words = ['dinosaur','fossil','jeep','jungle','escape','tunnel','volcano'];
      }
      idx = 0; gap = 56; setLives(3); playing = true; ended=false;
      mode='car'; anim={eatCar:false, catchRunner:false, escape:false}; escapeX=null;
      jeep.visible = true; driver.visible=false; driver.jumping=false; driver.x=190; driver.y=122; driver.vx=1.8; driver.vy=0;
      ensureAudio();
      try{ if(!musicMuted){ bgmAudio.currentTime=0; bgmAudio.play().catch(()=>{}); } }catch{}
      nextWord(true);
      answer.focus();
      showBanner('Game Start!', '#18345a');
    }
    function resetGame(){
      playing=false; ended=false;
      answer.value='';
      resizeSketch();
      showBanner('Reset', '#18345a');
    }

    function normalize(s){ return (s||'').trim().toLowerCase(); }

    function nextWord(first=false){
      if(idx >= words.length){ win(); return; }
      currentWord = words[idx];
      setProgress(idx, words.length);
      promptEl.textContent = `Listen and type the word ${idx+1} of ${words.length}.`;
      if(!first){ setTimeout(()=>speak(currentWord), 300); } else { speak(currentWord); }
    }

    function submitAnswer(){
      if(!playing || ended) return;
      const a = normalize(answer.value);
      const w = normalize(currentWord);
      if(a === w){
        sfxCorrect();
        gap += (mode==='car'? 22 : 18);
      }else{
        sfxWrong();
        setLives(lives-1);
        gap -= (mode==='car'? 18 : 16);
        if(lives===2 && mode==='car' && !anim.eatCar){
          anim.eatCar = true;
          eatCarSequence();
          return advanceWord();
        }
        if(lives<=0){
          return catchRunnerSequence();
        }
      }
      advanceWord();
    }
    function advanceWord(){
      idx++;
      answer.value='';
      nextWord();
    }

    // --- Transition sequences ---
    function eatCarSequence(){
      const step = ()=>{
        if(gap > 8){ gap -= 4; requestAnimationFrame(step); return; }
        sfxRoar();
        setTimeout(()=>{
          jeep.visible = false;
          mode = 'runner';
          driver.visible = true;
          gap = 36;
          anim.eatCar = false;
        }, 300);
      };
      step();
    }

    function catchRunnerSequence(){
      playing=false;
      sfxRoar();
      anim.catchRunner = true;
      // show GAME OVER sign immediately
      overlay('ü¶ñ The T‚ÄëRex got you!', 'Game Over');
      // pull gap then driver jumps up and off-screen
      const closeStep = ()=>{
        if(gap > 6){ gap -= 3; requestAnimationFrame(closeStep); return; }
        driver.jumping = true;
        driver.vy = -4.2;
        driver.vx = 2.2;
      };
      closeStep();
    }

    function win(){
      ended=true; playing=false;
      anim.escape = true;
      sfxEscape();
      showBanner('You Escaped!', '#225c2a');
      escapeX = (mode==='car' ? jeep.x : driver.x);
    }

    // Simple overlay message
    let overlayDiv = null;
    function overlay(title, sub){
      if(overlayDiv){ overlayDiv.remove(); }
      overlayDiv = document.createElement('div');
      overlayDiv.className = 'overlay';
      overlayDiv.innerHTML = `
        <div class="panel">
          <div style="font-size:28px; font-weight:900; letter-spacing:1px">${title}</div>
          <div style="opacity:.9; margin-top:6px">${sub}</div>
          <div style="margin-top:10px">
            <button id="playAgain" class="btn-secondary">Play Again</button>
          </div>
        </div>`;
      document.getElementById('gameWrap').appendChild(overlayDiv);
      overlayDiv.querySelector('#playAgain').addEventListener('click', ()=>{
        overlayDiv.remove(); overlayDiv=null; resetGame();
      });
    }

    // --- Drawing helpers ---
    function drawSky(){
      // slightly less sky (lower horizon)
      const sky = g.createLinearGradient(0,0,0,H);
      sky.addColorStop(0,'#5eb9ff');
      sky.addColorStop(1,'#9fe4ff');
      g.fillStyle = sky;
      g.fillRect(0,0,W,H);
      // distant hills
      g.fillStyle = '#6bb769';
      drawHill(0,110, 80, 26);
      drawHill(90,116, 70, 24);
      drawHill(180,108, 90, 30);
      drawHill(260,118, 60, 22);
    }
    function drawHill(x, y, w, h){
      g.fillRect(x,y,w,h);
      g.fillRect(x+Math.floor(w*0.4), y-8, Math.floor(w*0.6), h+8);
    }
    function drawGround(scroll){
      const groundY = 130; // more ground, less sky
      // grass
      g.fillStyle = '#3ea950';
      g.fillRect(0,groundY,W, H-groundY);
      // dirt stripes (parallax)
      g.fillStyle = '#2b7a3a';
      const stripeH = 6;
      for(let i=0;i<5;i++){
        const y = groundY + 2 + i*stripeH;
        g.fillRect( - (scroll%16), y, W + 16, 2);
      }
      // bushes
      g.fillStyle = '#2e7d32';
      for(let x=-(scroll%40); x<W; x+=40){
        g.fillRect(x, groundY-6, 10, 6);
        g.fillRect(x+6, groundY-10, 8, 10);
      }
      // draw a tunnel on right if escaping
      if(anim.escape){
        drawTunnel();
      }
    }

    // Jurassic Park‚Äìstyle Jeep (tan w/ red accents)
    function drawJeep(x,y){
      if(!jeep.visible) return;
      // wheels (red rims)
      g.fillStyle='#111'; g.fillRect(x-20,y+16, 10,10); g.fillRect(x+16,y+16,10,10);
      g.fillStyle='#c62828'; g.fillRect(x-18,y+18, 6,6); g.fillRect(x+18,y+18, 6,6);
      // body (tan)
      g.fillStyle='#d9c3a5'; g.fillRect(x-26,y, 60,16);
      // bumpers / grille
      g.fillStyle='#303030'; g.fillRect(x-30,y+4, 4,10); g.fillRect(x+34,y+4, 4,10);
      // roll bars
      g.fillStyle='#2b2b2b'; g.fillRect(x-18,y-10, 4,10); g.fillRect(x+10,y-10, 4,10);
      g.fillRect(x-18,y-12, 32,3);
      // cabin glass
      g.fillStyle='#a9cee8'; g.fillRect(x-10,y-8, 22,8);
      // red stripes
      g.fillStyle='#cc2c2c'; g.fillRect(x-26,y+8, 60,3);
      g.fillRect(x-26,y+3, 18,2); g.fillRect(x+8,y+3, 18,2);
      // faux door logo
      g.fillStyle='#b71c1c'; g.fillRect(x-6,y+2, 6,6);
      g.fillStyle='#ffd460'; g.fillRect(x-5,y+3, 1,4); g.fillRect(x-3,y+3, 1,4);
      // headlight
      g.fillStyle='#fff59d'; g.fillRect(x+30,y+6, 4,4);
      // spare tire
      g.fillStyle='#111'; g.fillRect(x-32,y+8, 6,6);
    }

    // Pixel runner (driver) with hat
    function drawDriver(x,y,frame){
      if(!driver.visible) return;
      // torso
      g.fillStyle='#e0e0e0'; g.fillRect(x-3,y-10, 6,10);
      // head
      g.fillStyle='#ffcc99'; g.fillRect(x-3,y-16, 6,6);
      // little Grant-style hat (tan)
      g.fillStyle='#b58a5a'; // crown
      g.fillRect(x-3,y-18, 6,3);
      // brim
      g.fillStyle='#a67c52';
      g.fillRect(x-6,y-17, 12,2);
      // legs (alternate)
      const leg = (frame%12<6)? -2 : 2;
      g.fillStyle='#3f51b5'; g.fillRect(x-6+leg,y, 4,8);
      g.fillRect(x+2-leg,y, 4,8);
      // arms
      g.fillStyle='#ffcc99'; g.fillRect(x-6,y-8, 4,4);
      g.fillRect(x+2,y-8, 4,4);
    }

    // Big T-Rex with mouth animation
    function drawRex(x,y,frame,scale){
      g.save();
      g.translate(x,y);
      g.scale(scale,scale);
      // tail
      g.fillStyle='#3a6736'; g.fillRect(-40,6, 16,6); g.fillRect(-24,4, 10,8);
      // body
      g.fillRect(-18,0, 30,20);
      // legs run cycle
      const stride = (frame%20<10)? 0 : 4;
      g.fillRect(-8,20, 8,8); g.fillRect(-6+stride,28, 6,6);
      g.fillRect(8,20, 8,8);  g.fillRect(10-stride,28, 6,6);
      // arm
      g.fillRect(6,10, 8,4);
      // neck & head
      g.fillRect(8,-12, 12,12);
      const mouthOpen = (frame%16<8) ? 1 : 0;
      g.fillRect(18,-10, 14,10); // skull
      // mouth
      if(mouthOpen){
        g.fillStyle='#203018';
        g.fillRect(18,-2, 14,6);
        g.fillStyle='#fff';
        g.fillRect(20,-2, 3,2); g.fillRect(24,-2, 3,2); g.fillRect(28,-2, 3,2);
        g.fillRect(22,2, 3,2);  g.fillRect(26,2, 3,2);
      }else{
        g.fillStyle='#fff';
        g.fillRect(20,-2, 10,2);
      }
      // eye
      g.fillStyle='#000'; g.fillRect(28,-6, 2,2);
      g.restore();
    }

    function drawTunnel(){
      // right-side tunnel entrance
      const tx = W - 30;
      const ty = 120;
      g.fillStyle = '#1f1f1f';
      g.fillRect(tx, ty-10, 26, 40);
      g.fillStyle = '#555';
      g.fillRect(tx+2, ty-6, 22, 32);
      // yellow stripe road
      g.fillStyle = '#ffd460';
      g.fillRect(tx-60, ty+21, 60, 2);
    }

    // Animation loop
    function loop(){
      t++;
      bgScroll += 0.7;
      drawSky();
      drawGround(bgScroll);

      // Position entities from gap centerpoint unless escaping
      if(!anim.escape){
        if(mode==='car'){
          jeep.x = 170 + gap/2;
          jeep.y = 104 + Math.sin(t/12)*1.2;
        }else{
          driver.x = 170 + gap/2;
          driver.y = 122 + Math.sin(t/9)*1.0;
        }
      }else{
        // escape run: move entity to the right off-screen while tunnel is visible
        if(escapeX==null){ escapeX = (mode==='car'? jeep.x : driver.x); }
        escapeX += (mode==='car' ? 3.2 : 2.8);
        if(mode==='car'){
          jeep.x = escapeX; jeep.y = 104 + Math.sin(t/12)*1.0;
        }else{
          driver.x = escapeX; driver.y = 122 + Math.sin(t/9)*0.8;
        }
        // push rex back
        gap += 2.2;
        if((mode==='car' ? jeep.x : driver.x) > W + 40){
          anim.escape=false;
          overlay('üèÅ You escaped!', 'You made it to the tunnel!');
        }
      }

      rex.x  = 150 - gap/2;
      rex.y  = 86 + Math.sin(t/9)*1.0;
      rex.frame = t;

      // Clamp
      if(mode==='car'){
        jeep.x = Math.max(36, Math.min(W+80, jeep.x));
      }else{
        driver.x = Math.max(-40, Math.min(W+80, driver.x));
      }
      rex.x  = Math.max(18, Math.min(W-36, rex.x));

      // Draw entities
      if(mode==='car'){ drawJeep(jeep.x, jeep.y); }
      else { drawDriver(driver.x, driver.y, t); }
      drawRex(rex.x, rex.y, rex.frame, rex.scale);

      // Driver physics if jumping (during catch animation)
      if(driver.jumping){
        driver.vy += 0.18; // gravity
        driver.x  += driver.vx;
        driver.y  += driver.vy;
        // when fully off-screen, stop motion
        if(driver.y < -20 || driver.x > W+20 || driver.x < -20){
          driver.jumping = false;
        }
      }

      // Near-roar cue (not muted by music toggle)
      if(playing && gap < 14){
        const now = performance.now();
        if(now - lastRoarAt > 2000){ sfxRoar(); }
        // subtle camera shake
        const dx = (Math.random()-.5)*2;
        const dy = (Math.random()-.5)*2;
        g.drawImage(gameCanvas, dx, dy);
      }

      requestAnimationFrame(loop);
    }
    loop();

    // --- Events ---
    startBtn.addEventListener('click', startGame);
    goBtn.addEventListener('click', submitAnswer);
    replayBtn.addEventListener('click', ()=> speak(currentWord));
    resetBtn.addEventListener('click', resetGame);
    answer.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ submitAnswer(); }
    });
    muteBtn.addEventListener('click', toggleMusic);

    // --- Sketch pad drawing (mouse + touch) ---
    let drawing=false, lastX=0, lastY=0;
    function skDown(x,y){ drawing=true; lastX=x; lastY=y; }
    function skMove(x,y){
      if(!drawing) return;
      sg.strokeStyle = '#e9eef6';
      sg.lineWidth = penWidth;
      sg.beginPath();
      sg.moveTo(lastX,lastY);
      sg.lineTo(x,y);
      sg.stroke();
      lastX=x; lastY=y;
    }
    function skUp(){ drawing=false; }

    function getPos(e){
      const rect = sketch.getBoundingClientRect();
      if(e.touches && e.touches[0]){
        return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
      }else{
        return { x: e.clientX - rect.left, y: e.clientY - rect.top };
      }
    }

    sketch.addEventListener('mousedown', (e)=>{ const p=getPos(e); skDown(p.x,p.y); });
    sketch.addEventListener('mousemove', (e)=>{ const p=getPos(e); skMove(p.x,p.y); });
    window.addEventListener('mouseup',  skUp);

    sketch.addEventListener('touchstart', (e)=>{ const p=getPos(e); skDown(p.x,p.y); e.preventDefault(); }, {passive:false});
    sketch.addEventListener('touchmove',  (e)=>{ const p=getPos(e); skMove(p.x,p.y); e.preventDefault(); }, {passive:false});
    sketch.addEventListener('touchend',   (e)=>{ skUp(); e.preventDefault(); }, {passive:false});

    clearSketch.addEventListener('click', ()=> resizeSketch());
    thinPen.addEventListener('click', ()=>{ penWidth=3; });
    thickPen.addEventListener('click',()=>{ penWidth=7; });

    window.addEventListener('resize', resizeSketch);
    resizeSketch();

    // preload voices event hook
    if ('speechSynthesis' in window){
      window.speechSynthesis.onvoiceschanged = ()=>{};
    }
  })();
  </script>
</body>
</html>
